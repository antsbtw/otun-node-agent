name: Build sing-box

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      singbox_version:
        description: 'sing-box version (e.g., 1.10.7)'
        required: true
        default: '1.10.7'

permissions:
  contents: write

env:
  SINGBOX_VERSION: ${{ github.event.inputs.singbox_version || '1.10.7' }}

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Clone sing-box source
        run: |
          git clone --depth 1 --branch "v${{ env.SINGBOX_VERSION }}" https://github.com/SagerNet/sing-box.git sing-box-src

      - name: Build sing-box
        run: |
          cd sing-box-src
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
            go build -tags "with_v2ray_api,with_utls,with_reality_server" \
            -ldflags "-s -w" \
            -o ../sing-box-${{ matrix.goos }}-${{ matrix.goarch }} \
            ./cmd/sing-box

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sing-box-${{ matrix.goos }}-${{ matrix.goarch }}
          path: sing-box-${{ matrix.goos }}-${{ matrix.goarch }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          find artifacts -type f -name 'sing-box-*' -exec mv {} release/ \;
          chmod +x release/*
          ls -la release/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.SINGBOX_VERSION }}
          name: sing-box v${{ env.SINGBOX_VERSION }} (with v2ray_api)
          body: |
            Pre-built sing-box binaries with the following features enabled:
            - `with_v2ray_api`: Traffic statistics support
            - `with_utls`: Reality protocol support

            ## Downloads
            - `sing-box-linux-amd64` - For x86_64 servers
            - `sing-box-linux-arm64` - For ARM64 servers (e.g., AWS Graviton)

            ## Usage
            These binaries are automatically downloaded by the install script.
          files: release/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
